# NIS2 Infrastructure Kit

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Docker](https://img.shields.io/badge/Docker-Ready-blue.svg)](https://www.docker.com/)
[![Helm](https://img.shields.io/badge/Helm-v1.0.0-0f1689.svg)](./charts/nis2shield)
[![Terraform](https://img.shields.io/badge/Terraform-AWS%20%7C%20GCP%20%7C%20Azure-7b42bc.svg)](./terraform)
[![Open in Gitpod](https://gitpod.io/button/open-in-gitpod.svg)](https://gitpod.io/#https://github.com/nis2shield/infrastructure)

**Secure-by-Design Infrastructure for NIS2 Compliance.**

This repository provides the "last mile" for NIS2 compliance: **secure infrastructure**. Deploy with Docker Compose, Helm (Kubernetes), or Terraform (Cloud). While [django-nis2-shield](https://github.com/nis2shield/django-nis2-shield), [nis2-spring-shield](https://github.com/nis2shield/nis2-spring-shield), and [@nis2shield/react-guard](https://github.com/nis2shield/react-guard) protect your code, this kit protects the **execution environment**.

> **ğŸ‰ Now supports both Django and Spring Boot applications!** Same JSON log format, same infrastructure.

## âœ¨ Features

- ğŸ”’ **Hardened Containers**: Non-root execution, read-only filesystem
- ğŸ“Š **Log Segregation**: Logs exported via sidecar (Fluent Bit)
- ğŸ’¾ **Automated Backups**: PostgreSQL dumps with retention policy
- ğŸ” **Encrypted Twin**: Zero-trust cloud backup (AES-256 + RSA)
- ğŸ›¡ï¸ **Compliance Engine**: Automated `tfsec` & `gitleaks` checks in CI/CD
- ğŸ“ˆ **Dynamic Reporting**: Updates `NIS2_SELF_ASSESSMENT.md` automatically
- â˜¸ï¸ **Kubernetes Ready**: Production Helm chart with NetworkPolicies
- â˜ï¸ **Multi-Cloud**: Terraform modules for AWS, GCP, Azure
- ğŸ—ï¸ **NIS2 Compliant**: Addresses Art. 21 infrastructure requirements

## ğŸ“‹ Architecture

### Base Stack

```mermaid
graph TB
    subgraph Docker["Docker Compose Stack"]
        webapp["ğŸ/â˜• webapp<br/>(Django or Spring Boot)"]
        logs["ğŸ“Š log-collector<br/>(Fluent Bit)"]
        backup["ğŸ’¾ db-backup<br/>(Cron)"]
        db[(PostgreSQL)]
        
        webapp --> |writes logs| logs
        webapp --> db
        backup --> |dumps| db
    end
    
    logs --> |forwards to| SIEM["ğŸ”’ SIEM/Elasticsearch"]
    backup --> |stores| Storage["ğŸ“ ./backups/"]
    
    style webapp fill:#3b82f6
    style logs fill:#10b981
    style backup fill:#f59e0b
    style db fill:#8b5cf6
```

> **Note**: The JSON log format is identical for both Django and Spring Boot applications, ensuring seamless interoperability.

### Security Features

| Component | Protection |
|-----------|------------|
| webapp | Non-root, read-only filesystem, tmpfs |
| log-collector | Read-only log access, SIEM forwarding |
| db-backup | 7-day retention, optional GPG encryption |
| PostgreSQL | Dedicated volume, health checks |

---

### ğŸ” Encrypted Twin (Disaster Recovery)

The **Crypto-Replicator** provides zero-trust cloud backup:

```mermaid
sequenceDiagram
    participant DB as PostgreSQL
    participant CR as Crypto-Replicator
    participant Cloud as â˜ï¸ Cloud Storage
    
    DB->>CR: NOTIFY (change event)
    
    Note over CR: 1. Generate AES session key
    Note over CR: 2. Encrypt data with AES-GCM
    Note over CR: 3. Wrap key with RSA public
    
    CR->>Cloud: Encrypted Envelope
    
    Note over Cloud: âš ï¸ Cannot decrypt!<br/>(no private key)
```

**Key Features:**
- ğŸ”’ **AES-256-GCM** - Authenticated data encryption
- ğŸ”‘ **RSA-OAEP** - Asymmetric key wrapping
- ğŸ”„ **Forward Secrecy** - Unique session key per message
- â˜ï¸ **Zero-Trust Cloud** - Cloud cannot read your data

### ğŸ›¡ï¸ The Truth vs The Proof

This infrastructure is designed to support the **NIS2Shield** business model:

1.  **The Truth (Open Source)**:
    *   **Secure Infrastructure**: All the Docker/Helm/Terraform code in this repo is free and MIT licensed.
    *   **Static Guardrails**: We provide configs for `tfsec` and `gitleaks` to block insecurity in CI/CD.
    *   **Self-Assessment**: The manual [docs/NIS2_SELF_ASSESSMENT.md](docs/NIS2_SELF_ASSESSMENT.md) checklist.

2.  **The Proof (Auditor Kit - Commercial)**:
    *   **Compliance Engine**: The proprietary binary that connects to this infrastructure.
    *   **Automated Reporting**: It parses the logs generated by these containers to verify operational requirements (e.g., "Did backups run?").
    *   **Legal PDF**: Automatically generates the signed report for your auditor.

> **Note**: This repository contains "The Truth" (the secure runtime). To get the automated "Proof" (Compliance Engine & Reports), see cur **[Pro Auditor Kit](https://nis2shield.com/pricing)**.

## ğŸš€ Quick Start


### Prerequisites

- Docker & Docker Compose v2+
- A Docker image of your application using:
  - **Django**: [django-nis2-shield](https://github.com/nis2shield/django-nis2-shield)
  - **Spring Boot**: [nis2-spring-shield](https://github.com/nis2shield/nis2-spring-shield)

### Installation

```bash
# Clone the repository
git clone https://github.com/nis2shield/infrastructure.git
cd infrastructure

# Copy environment template
cp .env.example .env

# Edit .env with your values (IMPORTANT: change passwords!)
nano .env

# Start the stack
docker-compose up -d

# Check status
docker-compose ps
```

## âš™ï¸ Services

### 1. webapp (Application Layer)

Your Django or Spring Boot application, hardened with:
- `user: 1000:1000` - Non-root execution
- `read_only: true` - Immutable filesystem
- `tmpfs: /tmp` - RAM-only writable directory

> **Spring Boot**: See `examples/docker-compose.spring.yml` for a Spring-specific example.

### 2. log-collector (Fluent Bit Sidecar)

Reads logs from shared volume and forwards to:
- **Console** (default, for development)
- **Elasticsearch** (uncomment in config)
- **HTTP/SIEM** (Intrusa, Splunk HEC, etc.)

Edit `monitoring/fluent-bit.conf` to configure outputs.

### 3. db-backup (Business Continuity)

Automated PostgreSQL backups:
- Schedule: `@every 6h00m` (configurable)
- Retention: 7 days (configurable)
- Location: `./backups/`

## ğŸ”„ Disaster Recovery Testing

Test that your backups can be restored (NIS2 Art. 21c requirement):

```bash
# Run the automated restore test
./scripts/restore-test.sh

# Or specify a backup file
./scripts/restore-test.sh ./backups/mybackup.sql.gz
```

The script will:
1. Start an empty PostgreSQL container
2. Restore the latest backup
3. Validate the data integrity
4. Generate a compliance report

Keep the generated report for your NIS2 audit documentation.

## ğŸ“Š ELK Stack (Elasticsearch + Kibana)

Visualize your NIS2 logs in a beautiful dashboard:

```bash
# Quick setup (starts ES + Kibana + configures index)
./scripts/elk-setup.sh

# Or manually
docker-compose -f docker-compose.yml -f docker-compose.elk.yml up -d
```

Once running:
- **Kibana**: http://localhost:5601
- **Elasticsearch**: http://localhost:9200

Go to Kibana â†’ Analytics â†’ Discover â†’ Select "NIS2 Logs" to see your logs.

> **Note**: ELK requires ~1.5GB RAM. Use the base stack for low-memory systems.

## ğŸ“ˆ Prometheus + Grafana Monitoring

Real-time metrics and NIS2 compliance dashboard:

```bash
# Quick setup
./scripts/monitoring-setup.sh

# Or manually
docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d
```

Access:
- **Grafana**: http://localhost:3000 (admin/admin)
- **Prometheus**: http://localhost:9090

Pre-configured NIS2 dashboard includes:
- Request rate and error percentage
- Backup age monitoring
- System resource usage

## â˜¸ï¸ Kubernetes (Helm Chart)

For enterprise deployments, use our production-ready Helm chart:

```bash
# Install from local
helm install nis2shield ./charts/nis2shield -n nis2 --create-namespace

# With custom values
helm install nis2shield ./charts/nis2shield -f values-prod.yaml
```

Features:
- ğŸ”’ Security hardening (PSS restricted, runAsNonRoot)
- ğŸŒ Ingress with TLS support
- ğŸ” NetworkPolicies for service isolation
- âš™ï¸ Toggle modules (replicator, monitoring)

ğŸ‘‰ **[Enterprise Deployment Guide](https://nis2shield.com/enterprise/)**

## â˜ï¸ Cloud Deployment (Terraform)

Infrastructure-as-Code for major cloud providers:

| Provider | Resources | Command |
|----------|-----------|--------|
| **AWS** | VPC, EKS, RDS, S3, KMS | `cd terraform/aws && terraform apply` |
| **GCP** | VPC, GKE, Cloud SQL, Storage | `cd terraform/gcp && terraform apply` |
| **Azure** | VNet, AKS, PostgreSQL, KeyVault | `cd terraform/azure && terraform apply` |

All modules include:
- Encrypted databases with managed keys
- Private networking (no public IPs)
- Secrets management integration
- High availability options

## ğŸ“ Project Structure

```
infrastructure/
â”œâ”€â”€ charts/nis2shield/              # â˜¸ï¸ Helm Chart (K8s)
â”‚   â”œâ”€â”€ Chart.yaml
â”‚   â”œâ”€â”€ values.yaml
â”‚   â””â”€â”€ templates/                  # Deployments, Services, etc.
â”‚
â”œâ”€â”€ terraform/                      # â˜ï¸ Cloud IaC
â”‚   â”œâ”€â”€ aws/                        # VPC, EKS, RDS, S3
â”‚   â”œâ”€â”€ gcp/                        # VPC, GKE, Cloud SQL
â”‚   â””â”€â”€ azure/                      # VNet, AKS, PostgreSQL
â”‚
â”œâ”€â”€ docker-compose.yml              # Base stack
â”œâ”€â”€ docker-compose.prod.yml         # Production overrides
â”œâ”€â”€ docker-compose.elk.yml          # ELK observability
â”œâ”€â”€ docker-compose.monitoring.yml   # Prometheus + Grafana
â”‚
â”œâ”€â”€ crypto-replicator/              # ğŸ” Encrypted Twin
â”‚   â”œâ”€â”€ crypto_replicator/          # Python modules
â”‚   â”œâ”€â”€ docs/                       # OpenAPI spec
â”‚   â””â”€â”€ tests/                      # Unit + integration
â”‚
â”œâ”€â”€ monitoring/                     # Fluent Bit, Prometheus
â””â”€â”€ scripts/                        # Setup & DR testing
```

## ğŸ” NIS2 Compliance Matrix

| NIS2 Article | Requirement | Infrastructure Solution |
|--------------|-------------|------------------------|
| Art. 21 (a) | Risk analysis & system security | Hardened containers, non-root |
| Art. 21 (b) | Incident management | Centralized, segregated logs |
| Art. 21 (c) | Business continuity | Automated backups with retention |
| Art. 21 (d) | Supply chain security | Verified base images |
| Art. 21 (e) | Security hygiene | Read-only filesystem |

## ğŸ”§ Configuration

### SIEM Integration

Edit `monitoring/fluent-bit.conf`:

```ini
# Uncomment for Elasticsearch
[OUTPUT]
    Name              es
    Host              ${ELASTICSEARCH_HOST}
    Port              9200
    Index             nis2-logs
```

### Backup Schedule

In `docker-compose.yml` or `.env`:

```yaml
SCHEDULE=@every 6h00m   # Every 6 hours
BACKUP_KEEP_DAYS=7      # Keep 7 days
```

## ğŸ¤ Related Projects

- [django-nis2-shield](https://github.com/nis2shield/django-nis2-shield) - Django middleware for NIS2 compliance
- [nis2-spring-shield](https://github.com/nis2shield/nis2-spring-shield) - Spring Boot starter for NIS2 compliance âœ¨ NEW
- [@nis2shield/react-guard](https://github.com/nis2shield/react-guard) - Frontend protection
- [nis2shield.com](https://nis2shield.com) - Documentation hub

## ğŸ“„ License

MIT License - see [LICENSE](LICENSE) for details.

## ğŸ™‹ Contributing

Contributions welcome! See [CONTRIBUTING.md](CONTRIBUTING.md).

---

**Part of the [NIS2 Shield](https://nis2shield.com) ecosystem** ğŸ›¡ï¸