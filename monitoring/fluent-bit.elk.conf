[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Path              /var/log/shared/app.json
    Tag               nis2.app
    Parser            json
    DB                /var/log/flb_state.db
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    Refresh_Interval  5

[FILTER]
    Name              record_modifier
    Match             *
    Record            hostname ${HOSTNAME}
    Record            service nis2-app
    Record            environment production
    Record            framework django

# Add timestamp if not present
[FILTER]
    Name              lua
    Match             *
    script            /fluent-bit/etc/add_timestamp.lua
    call              add_timestamp

# Output to Elasticsearch
[OUTPUT]
    Name              es
    Match             *
    Host              ${ELASTICSEARCH_HOST}
    Port              ${ELASTICSEARCH_PORT}
    Index             nis2-logs
    Type              _doc
    Logstash_Format   On
    Logstash_Prefix   nis2
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           _flb_tag
    Suppress_Type_Name On
    # Retry on failure
    Retry_Limit       3

# Also output to console for debugging
[OUTPUT]
    Name              stdout
    Match             *
    Format            json_lines
